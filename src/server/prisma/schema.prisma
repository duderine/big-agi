// Prisma is the ORM for server-side (API) access to the database
//
// This file defines the schema for the database.
//  - make sure to run 'prisma generate' after making changes to this file
//  - make sure to run 'prisma db push' to sync the remote database with the schema
//
// Database is optional: when the environment variables are not set, the database is not used at all,
// and the storage of data in Big-AGI is limited to client-side (browser) storage.
//
// The database is used for:
//  - the 'sharing' function, to let users share the chats with each other

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

//
// Storage of Linked Data
//
model LinkStorage {
  id String @id @default(uuid())

  ownerId    String
  visibility LinkStorageVisibility

  dataType  LinkStorageDataType
  dataTitle String?
  dataSize  Int
  data      Json

  upVotes    Int @default(0)
  downVotes  Int @default(0)
  flagsCount Int @default(0)
  readCount  Int @default(0)
  writeCount Int @default(1)

  // time-based expiration
  expiresAt DateTime?

  // manual deletion
  deletionKey String
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum LinkStorageVisibility {
  PUBLIC
  UNLISTED
  PRIVATE
}

enum LinkStorageDataType {
  CHAT_V1
}

//
// Storage of Assets (migrated from IndexedDB)
//
model Asset {
  id String @id @default(uuid())

  // Asset identification and classification
  assetType AssetAssetType
  label     String

  // Asset data (base64 encoded)
  mimeType String
  base64   String // Base64 encoded content (not a data URL)

  // Asset origin information
  originType AssetOriginType // 'user' | 'generated'
  originSource String // e.g., 'attachment', 'ai-text-to-image'
  originMedia String? // e.g., 'camera', 'screencapture', 'file-open'
  originUrl String?
  originFileName String?
  originGeneratorName String?
  originPrompt String?
  originParameters Json?
  originGeneratedAt DateTime?

  // Asset metadata (JSON for flexibility)
  metadata Json // Contains type-specific metadata

  // Cache for thumbnails and conversions
  cache Json // Contains cached conversions like thumb256

  // Context and scope (migrated from IndexedDB)
  contextId AssetContextId @default(GLOBAL)
  scopeId   AssetScopeId

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for performance
  @@index([assetType])
  @@index([contextId, scopeId])
  @@index([assetType, contextId, scopeId])
  @@index([mimeType])
  @@index([originType, originSource])
  @@index([createdAt])
}

enum AssetAssetType {
  IMAGE
  AUDIO
  // VIDEO
  // DOCUMENT
  // TEXT
}

enum AssetOriginType {
  USER
  GENERATED
}

enum AssetContextId {
  GLOBAL
}

enum AssetScopeId {
  APP_CHAT
  APP_DRAW
  ATTACHMENT_DRAFTS
}
